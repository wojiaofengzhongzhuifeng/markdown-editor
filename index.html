<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>

<div id="content" contenteditable style="border: 1px solid red"></div>
<h2>功能说明</h2>
<ol>
  <li>用户输入a-z普通英文字符和数字，则显示对应字符</li>
  <li>用户按下del键时，在当前位置往前删除一个字符</li>
  <li>如果用户输入了数字，则将其替换显示中文数字</li>
  <li><del>用户输入回车键，可以进行换行输入</del></li>
  <li>删除某个位置单字符</li>
  <li>在非末尾新增字符</li>
</ol>

<script>
  const content = document.querySelector('#content')
  let map = {
    1: '一',
    2: '二',
    3:'三',
    4:'四',
    5:'五',
    6: '六',
    7: '七',
    8: '八',
    9: '九',
    0: '零'
  }
  // 监听用户的键盘事件
  content.addEventListener('beforeinput', (e)=>{
    // 禁止默认事件，不能通过键盘输入内容
    e.preventDefault();
    console.log(e);
    let {inputType} = e

    if(inputType === 'insertText'){
      // 处理用户输入值
      handleInput(e)
    } else if (inputType === 'deleteContentBackward'){
      // 处理用户删除
      handleDelete(e)
    } else if (inputType === 'insertParagraph'){
      // todo 处理用户换行
      // handleWordBreak(e)
    }
  })

  function handleInput(e){
    // 最简单的实现：将用户输入追加到最后
    let userInputContent = e.data

    if(isNumber(userInputContent)){
      userInputContent = map[userInputContent]
    }

    let newContent = content.innerText + userInputContent
    content.innerText = newContent
    // 处理光标
    handleRange(e)
  }

  // 使用js控制光标位置
  function handleRange(e, startNumber){
    let selection = window.getSelection()
    let node = e.path[0].childNodes[e.path[0].childNodes.length - 1]
    console.log('node', node);
    if(!node){return}
    if(node.nodeName === 'BR'){

    } else {
      let nodeInnerText = node.data
      // let textLength = nodeInnerText === ' ' ? 0 :  nodeInnerText.length

      let range = document.createRange()
      range.setStart(node, isNumber(startNumber) ? startNumber : nodeInnerText.length)
      range.collapse(true)
      selection.removeAllRanges()
      selection.addRange(range) // 核心 api
    }


  }
  function handleDelete(e){
    let selection = window.getSelection();
    const {type, anchorOffset, focusOffset} = selection
    let contentTextList = content.innerText.split('')
    let deleteNumber = 0
    let startNumber = 0
    if(type === 'Caret'){
      // 特殊情况：光标在初始位置，尝试删除操作，这时候不能删除任何内容
      if(anchorOffset === 0){
        startNumber = 0
        deleteNumber = 0
      } else {
        startNumber = anchorOffset - 1
        deleteNumber = 1
      }

    } else {
      deleteNumber = Math.abs(focusOffset - anchorOffset)
      startNumber = Math.min(focusOffset, anchorOffset)
    }
    contentTextList.splice(startNumber, deleteNumber)

    content.innerText = contentTextList.join('')
    handleRange(e, startNumber)
  }

  function handleWordBreak(e){
    // 换行输入
    // 最简单的实现：将用户输入追加到最后
    let userInputContent = '\n'

    let newContent = content.innerText + userInputContent
    content.innerText = newContent

    const newtext = document.createTextNode(' ');
    content.appendChild(newtext)

    // content.innerHTML += '&nbsp;'

    // 处理光标
    handleRange(e)
  }

  function isNumber(str){
    return !isNaN(Number(str))
  }


</script>
</body>
</html>
